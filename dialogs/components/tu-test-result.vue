<template>
  <div class="tu-test-result">
    <div v-for="failure in result.failures" class="tu-test-failure">
      <div class="tu-title">
        <a href="failure.location"
            v-on:click.prevent="openEditor(failure.location)"
            title="Click to open file in editor">
          {{ failure.location }}
        </a>
      </div>
      <pre class="tu-message"
        v-on:click="interceptLinks"
        v-html="$options.filters.linkify(failure.message)"></pre>
    </div>
  </div>
</template>

<script>
import Vue from "vue";
export default Vue.extend({
  name: 'tu-test-result',
  props: ['result'],
  filters: {
    linkify(string) {
      let escaped = this.escape_html(string);
      var pattern = /^(\s*)(.+\.rb[es]?:\d+)/gm;
      var replacement = "$1<a href='$2' data-location='$2' title='Click to open file in editor'>$2</a>";
      var html = escaped.replace(pattern, replacement);
      return html;
    },
    escape_html(string) {
      let html = string.replace(/&/g, "&amp;");
      html = html.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      return html;
    },
  },
  methods: {
    openEditor(location) {
      sketchup.openSourceFile(location);
    },
    interceptLinks(event) {
      // Because the content of .tu-message is dynamically generated by a
      // Vue filter normal Vue event listener cannot be attached on the
      // A elements. Instead the .tu-message click event is used to detect
      // clicks on child-A elements.
      if (event.srcElement.href) {
        event.preventDefault();
        sketchup.openSourceFile(event.srcElement.dataset.location);
      }
    },
  },
})
</script>
